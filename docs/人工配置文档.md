# GitHub Global - 人工配置文档

本文档说明在启动项目前需要手动完成的配置步骤。

---

## 1. 创建 GitHub App

### 1.1 访问 GitHub 设置

1. 登录 GitHub
2. 访问 **Settings** > **Developer settings** > **GitHub Apps**
3. 点击 **New GitHub App**

### 1.2 填写基本信息

| 字段 | 值 |
|------|-----|
| **GitHub App name** | `GitHub Global` (或你自定义的名称) |
| **Homepage URL** | `http://localhost:3000` (开发环境) 或你的域名 |
| **Callback URL** | `http://localhost:3000/api/auth/callback/github` |
| **Setup URL** | `http://localhost:3000/dashboard` (可选) |
| **Webhook URL** | `http://localhost:3000/api/webhooks/github` (可选) |
| **Webhook Secret** | 随机生成一个密钥 (可使用 `openssl rand -hex 32`) |

### 1.3 配置权限

#### Repository Permissions（仓库权限）

| 权限 | 级别 | 说明 |
|------|------|------|
| **Contents** | Read & Write | 读取仓库文件、创建翻译文件、创建分支 |
| **Metadata** | Read | 读取仓库基本信息 |
| **Pull requests** | Read & Write | 创建和管理 Pull Request |

#### Account Permissions（账户权限）

| 权限 | 级别 | 说明 |
|------|------|------|
| **Email addresses** | Read | 获取用户邮箱用于 commit 提交 |

### 1.4 订阅事件（可选）

如果需要自动同步功能，订阅以下事件：

- `push` - 检测代码变更
- `installation` - 监听 App 安装/卸载
- `installation_repositories` - 监听仓库添加/移除

### 1.5 保存配置

1. 点击 **Create GitHub App**
2. 创建成功后，记录以下信息：
   - **App ID**
   - **Client ID**
   - **Client Secret**（点击 Generate a new client secret）
3. 生成并下载 **Private Key**（点击 Generate a private key）

---

## 2. 配置 OpenRouter API Key

### 2.1 注册 OpenRouter 账号

1. 访问 [OpenRouter](https://openrouter.ai/)
2. 注册并登录账号

### 2.2 获取 API Key

1. 访问 [API Keys 页面](https://openrouter.ai/keys)
2. 点击 **Create Key**
3. 复制生成的 API Key（格式: `sk-or-v1-xxxxxxxx`）

### 2.3 充值（可选）

如果使用平台托管模式，需要为 OpenRouter 账户充值。

---

## 3. 配置 MySQL 数据库

### 3.1 安装 MySQL

#### Windows

1. 下载 [MySQL Installer](https://dev.mysql.com/downloads/installer/)
2. 安装 MySQL Server 8.0
3. 设置 root 密码

#### macOS

```bash
brew install mysql@8.0
brew services start mysql@8.0
```

#### Linux (Ubuntu/Debian)

```bash
sudo apt update
sudo apt install mysql-server
sudo systemctl start mysql
```

### 3.2 创建数据库

```sql
-- 登录 MySQL
mysql -u root -p

-- 创建数据库
CREATE DATABASE github_global CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 创建用户（可选）
CREATE USER 'github_global'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON github_global.* TO 'github_global'@'localhost';
FLUSH PRIVILEGES;
```

---

## 4. 配置环境变量

### 4.1 复制环境变量模板

```bash
cp .env.example .env
```

### 4.2 填写环境变量

编辑 `.env` 文件，填入以下配置：

```bash
# 数据库配置
DATABASE_URL="mysql://github_global:your_password@localhost:3306/github_global"

# NextAuth 配置
NEXTAUTH_URL="http://localhost:3000"
NEXTAUTH_SECRET="your-nextauth-secret-key"  # 使用 openssl rand -base64 32 生成

# GitHub App 配置
GITHUB_APP_ID="123456"  # 从 GitHub App 页面获取
GITHUB_APP_CLIENT_ID="Iv1.xxxxxxxxxx"  # 从 GitHub App 页面获取
GITHUB_APP_CLIENT_SECRET="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"  # 从 GitHub App 页面获取
GITHUB_APP_PRIVATE_KEY="-----BEGIN RSA PRIVATE KEY-----\nMIIEpAIBAAKCAQEA...\n-----END RSA PRIVATE KEY-----"  # 将下载的私钥内容替换 \n 为实际换行符
GITHUB_WEBHOOK_SECRET="your-webhook-secret"  # 创建 GitHub App 时设置的密钥

# 加密密钥 (32 bytes hex)
ENCRYPTION_KEY="0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef"  # 使用 openssl rand -hex 32 生成

# 平台托管的 OpenRouter API Key
PLATFORM_OPENROUTER_API_KEY="sk-or-v1-xxxxxxxxxxxxxxxx"  # 从 OpenRouter 获取
```

### 4.3 生成密钥

#### NEXTAUTH_SECRET

```bash
openssl rand -base64 32
```

#### ENCRYPTION_KEY

```bash
openssl rand -hex 32
```

#### GITHUB_WEBHOOK_SECRET

```bash
openssl rand -hex 32
```

### 4.4 处理 GitHub Private Key

GitHub 私钥是多行文本，需要特殊处理：

**方法 1: 使用 \n 转义**

```bash
GITHUB_APP_PRIVATE_KEY="-----BEGIN RSA PRIVATE KEY-----\nMIIEpAIBAAKCAQEA...\n-----END RSA PRIVATE KEY-----"
```

**方法 2: 使用环境变量文件（推荐）**

将私钥保存为 `private-key.pem` 文件，然后在代码中读取。

---

## 5. 安装 GitHub App

### 5.1 安装到个人账户

1. 访问你的 GitHub App 页面
2. 点击 **Install App**
3. 选择 **Only select repositories** 或 **All repositories**
4. 点击 **Install**

### 5.2 获取 Installation ID

安装完成后，URL 中会包含 Installation ID：

```
https://github.com/settings/installations/12345678
```

这里的 `12345678` 就是 Installation ID（会自动保存到数据库，无需手动配置）。

---

## 6. 配置说明总结

完成以上步骤后，你应该已经配置好：

- ✅ GitHub App（App ID、Client ID、Client Secret、Private Key）
- ✅ OpenRouter API Key
- ✅ MySQL 数据库
- ✅ 环境变量文件（.env）
- ✅ 安装 GitHub App 到你的账户

下一步请参考 [快速启动说明文档](./快速启动说明.md) 启动项目。

---

## 常见问题

### Q1: GitHub Private Key 格式错误

**问题**: 启动时报错 `Error: Invalid PEM formatted message`

**解决方案**: 
- 确保私钥包含完整的 `-----BEGIN RSA PRIVATE KEY-----` 和 `-----END RSA PRIVATE KEY-----`
- 确保换行符正确（使用 `\n` 或实际换行）
- 可以使用在线工具验证 PEM 格式

### Q2: 数据库连接失败

**问题**: 启动时报错 `Can't reach database server`

**解决方案**:
- 检查 MySQL 服务是否启动
- 检查 `DATABASE_URL` 配置是否正确
- 检查数据库用户权限

### Q3: OpenRouter API Key 无效

**问题**: 翻译时报错 `401 Unauthorized`

**解决方案**:
- 检查 API Key 是否正确复制
- 检查 OpenRouter 账户是否有余额
- 检查 API Key 是否已激活

---

## 安全建议

1. **不要提交 .env 文件到 Git**
   - 已在 `.gitignore` 中配置
   - 使用 `.env.example` 作为模板

2. **定期更换密钥**
   - NEXTAUTH_SECRET
   - ENCRYPTION_KEY
   - GITHUB_WEBHOOK_SECRET

3. **限制 GitHub App 权限**
   - 只授予必要的权限
   - 定期审查已安装的仓库

4. **保护 OpenRouter API Key**
   - 不要在客户端代码中暴露
   - 使用环境变量存储
   - 定期检查使用量

---

## 下一步

配置完成后，请参考 [快速启动说明文档](./快速启动说明.md) 启动项目。
